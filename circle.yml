machine:
  environment:
    SERVICE_ACCOUNT: haxweb-fr@haxweb-fr.iam.gserviceaccount.com
    CLOUDSDK_CORE_DISABLE_PROMPTS: 1
    CLOUDSDK_PYTHON_SITEPACKAGES: 1
    CLOUDSDK_INSTALL_DIR: /tmp
    APP_NAME: demo-node
    DOCKER_IMAGE: demo-node
    PROJECT_NAME: haxweb-fr
    CLUSTER_NAME: haxweb-fr
    CLOUDSDK_COMPUTE_ZONE: europe-west1-c
    DEBIAN_FRONTEND: noninteractive
    CLOUDSDK_PYTHON: python2.7
    ACCT-AUTH: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiaGF4d2ViLWZy\nIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMzM1OTE3ZTg5MTg3YzU2MTIwNDBiNTIzMTlkNzJhZWRj\nZjkwN2M1MiIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxu\nTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFEbzEwV3JQ\ndWo3T2RDQlxuRG9ualRZelRsMjZCQzR6bVNpclV5dXY2ZUdBaVhFbWkzUitqSFdsMDZXWlhxbEVC\nenUrV3BURjJCUk1YS29KNlxueVh4SFFISTdrdjBJNVBySjQ2d3ZPZkpMM2hROFhUelFuc1FDVmR3\nb2VnaUluR3hSYTE0SWlrSCtWaTNibGZ2aVxuTWN3eGcrZ2FNajFFeGoyb3NoeTlWY2V5Q3BIOE4y\nb2lTdVRab295TUFKYjNyTU91dkFDZXlCVHpzaU1GbGEvMlxuenMzTllpRzROcWcxTWdiQnZnb0lp\nbndSVXkveEpvWlY3MU9jNXA2RGVGUHplYXQ2VkZKTjFPOHFSMkhkaEhFbFxuSGpqVmltTmFrRDRL\nSFJ1aC9DZHJUZFE2QlorUlI2MmVvMmJ5NkQ3VGlDYktjcEIwR1Z0OEt5cHB0SEk0Vkt1U1xuMStm\na3RieWRBZ01CQUFFQ2dnRUFJUDY0Z2E3Vmh4eEhQcktYdVowNHNwZEg4b04zZ1A3TG1RSDBkTGJ3\nTUk1UlxuWlFIZXhOZWJKUlVhQ3B3NUJIK1ZsZ3hzdU9PNU05UXpUMEVVR21pNGgxYXFBc09vQWtv\nQUVXVXR2N0NGdjVRYVxuMVJsYWYxWTViNGJ6aEtCZC9SK3c0SmJ2Q1NLZk52bkhDdU94b3VhbFVt\na0NJNmZQL3dMV2JjSWxIVWJBTHpSSlxuM2l5NytPaHNiWllUUWtDc2kybVkxZkdzOHQ1c1h6NHlQ\nS2ZjeFQ4Q3lXdE5ySW9nL2I1d0hQQlZzQVlpMThUd1xuZmJWWXNVNFRTdS9IcE56WVZzeGJ3cTJq\nWGFJVC9oYmtGZXhHbXhWejhINWZtdUNPQUJ3SUJMa1RQRXVmR0FKZ1xuNTZ3M1U5Z3g4NWdacFN0\nZm5RNGozUzREQWRSbkpmRyswdm9qR2hwQndRS0JnUUQ3Q040b3JlUWxpK1pldXdFbFxuNzBRLzlB\nMEZrdGg0ZEpuSGE0MlA5Wm1xQ3JSSmVhUE5aWHFDZWZqL3QyOFdPMmNsTDl1aXVhZk5GazczaXJ5\nVFxuVDc5WXArVWxnTnhsbW0wR1huak9hZ0s4bjNnZFRmczJKcnAwVTFJTkRCeHZyK1hHTGlMNHBM\ndUlwRDdaVzAzd1xuanhaQWd4dGZFYzFZTERmclU2MmwvR0J1TFFLQmdRRHRja2R2V3g0bnc5dXRr\ndXltQ3ZBZnVhRW15ejRVbDVXRVxuWnlRMEZPM2ZjeCtMcEJwVERneURUU3U1ZXpqelVGNDBTQzRJ\nVHFXSnMyeCtpNE5Cc0k3bE9LRDZIVU5iVFpITlxuZmlxdURqODFjRDdheEZldURvS2MwOTNsOWE1\ndk5WVnJWcXRueFV4SG1SdkpEcjhOVVVTdmlxcG5VQmNtSElSRFxuOWtGd0VyRCtNUUtCZ0g4UUdn\nTFZJYW12aWtkZ3VGQVBMNmgvU3lnTEQrN0lkaDN1WHBVRFoyZ2VTdXIxMnVkWFxuK2c2WTFtUDQ0\nUTJMdThXaTE3VWg2OEZ2RFVGV3crUjhkUW5XMGJHTjdBQ3hqWVd2dzg0VzhwT3UxQWxoTTBwUlxu\naUFiaE5hTE5Bb2Uxck1RSERrUjBmVWZJZXRkaDA2MXpmM3ZmNExiYU4rbnRWOUNSWmsraDB0MXhB\nb0dCQUpyNlxuUnVQSWpoTVlRODZ6b2QveUxhNFhRN2FGV3p5bmY0Qk9yWk9Nd1lGaHE0cENEcWg4\nOSsvUE02VzVabjl3eWp2SFxuakx3QlVReGlYb0x0M2pyRzJVMkZPNVJqK3kyaG9IT0dVS2NRUjNO\nQ2t0UEk2UTJERFA3OVRjeWxJVGdXa0cwaFxud1hoV2p5WUFLZUY5elhjTXZ3N3dLNjZJMk1NWVE3\nL3ovOXY5WnlaUkFvR0FWNE43cUVSYmMvYnUwM0hGdWQ1cVxuV3AzamM2VW1jdUYxZTZiWi8zNU0x\nWWg2a29UNzBOT01DUy9RV1BBS2lzblRCS3d2ZEMyNFdkay9uT204MmhSc1xuNU8xbTFXWmtSVWtM\nZWhlWThvSklnVFpiUGhsM2pSa0lETGx5eWJvQnJ1TnZxT2dmRlJFWTRnQ1ltRHl3eE5vNFxucFJu\nbmRLSTFCUVI0SmFheDVMSTY2QTg9XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJj\nbGllbnRfZW1haWwiOiAiaGF4d2ViLWZyQGhheHdlYi1mci5pYW0uZ3NlcnZpY2VhY2NvdW50LmNv\nbSIsCiAgImNsaWVudF9pZCI6ICIxMTUxMDAxNDM3MDMxNjAzNTUwMzUiLAogICJhdXRoX3VyaSI6\nICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3Vy\naSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvdG9rZW4iLAogICJhdXRo\nX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1\ndGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29v\nZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9oYXh3ZWItZnIlNDBoYXh3ZWItZnIu\naWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iCn0K
  services:
    - docker
deployment:
  prod:
    branch: master
    commands:
      - echo ${ACCT_AUTH} | base64 -d > account-auth.json
      - cat account-auth.json
      - sudo apt-get remove python-virtualenv python-openssl python3-openssl
      - sudo apt-get update
      - sudo apt-get install python-openssl python3-openssl
      - sudo rm -rf /opt/google-cloud-sdk/
      - export CLOUDSDK_CORE_DISABLE_PROMPTS=1
      - export CLOUDSDK_PYTHON_SITEPACKAGES=1
      - wget https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-123.0.0-linux-x86_64.tar.gz
      - tar -zxvf google-cloud-sdk-123.0.0-linux-x86_64.tar.gz
      - rm google-cloud-sdk-123.0.0-linux-x86_64.tar.gz
      - google-cloud-sdk/install.sh --quiet --path-update false --usage-reporting false --command-completion false --bash-completion false
      - source ~/.bashrc
      - export CLOUDSDK_CORE_DISABLE_PROMPTS=0
      - /home/ubuntu/demo-node/google-cloud-sdk/bin/gcloud auth activate-service-account ${SERVICE_ACCOUNT} --key-file account-auth.json
      - /home/ubuntu/demo-node/google-cloud-sdk/bin/gcloud config set project $PROJECT_NAME
      - /home/ubuntu/demo-node/google-cloud-sdk/bin/gcloud --quiet config set container/cluster $CLUSTER_NAME
      # Reading the zone from the env var is not working so we set it here
      - /home/ubuntu/demo-node/google-cloud-sdk/bin/gcloud config set compute/zone ${CLOUDSDK_COMPUTE_ZONE}
      - /home/ubuntu/demo-node/google-cloud-sdk/bin/gcloud --quiet container clusters get-credentials $CLUSTER_NAME
      - docker build -t gcr.io/${PROJECT_NAME}/${DOCKER_IMAGE}:$CIRCLE_SHA1 .
      # Using a separate tag command until Docker 1.10 is available on CircleCI, then we can use two tags in the build command above
      - docker tag us.gcr.io/${PROJECT_NAME}/${DOCKER_IMAGE}:$CIRCLE_SHA1 gcr.io/${PROJECT_NAME}/${DOCKER_IMAGE}:latest
      - ./deploy.sh
