machine:
  environment:
    SERVICE_ACCOUNT: haxweb-fr@haxweb-fr.iam.gserviceaccount.com
    APP_NAME: demo-node
    DOCKER_IMAGE: demo-node
    PROJECT_NAME: haxweb-fr
    CLUSTER_NAME: haxweb-fr
    CLOUDSDK_COMPUTE_ZONE: europe-west1-c
    DEBIAN_FRONTEND: noninteractive
    ACCT_AUTH: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiaGF4d2ViLWZyIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMzM1OTE3ZTg5MTg3YzU2MTIwNDBiNTIzMTlkNzJhZWRjZjkwN2M1MiIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSAKS0VZLS0tLS1cbk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRRG8xMFdyUHVqN09kQ0JcbkRvbmpUWXpUbDI2QkM0em1TaXJVeXV2NmVHQWlYRW1pM1IrakhXbDA2V1pYcWxFQnp1K1dwVEYyQlJNWEtvSjZcbnlYeEhRSEk3a3YwSTVQcko0Nnd2T2ZKTDNoUThYVHpRbnNRQ1Zkd29lZ2lJbkd4UmExNElpa0grVmkzYmxmdmlcbk1jd3hnK2dhTWoxRXhqMm9zaHk5VmNleUNwSDhOMm9pU3VUWm9veU1BSmIzck1PdXZBQ2V5QlR6c2lNRmxhLzJcbnpzM05ZaUc0TnFnMU1nYkJ2Z29JaW53UlV5L3hKb1pWNzFPYzVwNkRlRlB6ZWF0NlZGSk4xTzhxUjJIZGhIRWxcbkhqalZpbU5ha0Q0S0hSdWgvQ2RyVGRRNkJaK1JSNjJlbzJieTZEN1RpQ2JLY3BCMEdWdDhLeXBwdEhJNFZLdVNcbjErZmt0YnlkQWdNQkFBRUNnZ0VBSVA2NGdhN1ZoeHhIUHJLWHVaMDRzcGRIOG9OM2dQN0xtUUgwZExid01JNVJcblpRSGV4TmViSlJVYUNwdzVCSCtWbGd4c3VPTzVNOVF6VDBFVUdtaTRoMWFxQXNPb0Frb0FFV1V0djdDRnY1UWFcbjFSbGFmMVk1YjRiemhLQmQvUit3NEpidkNTS2ZOdm5IQ3VPeG91YWxVbWtDSTZmUC93TFdiY0lsSFViQUx6UkpcbjNpeTcrT2hzYlpZVFFrQ3NpMm1ZMWZHczh0NXNYejR5UEtmY3hUOEN5V3ROcklvZy9iNXdIUEJWc0FZaTE4VHdcbmZiVllzVTRUU3UvSHBOellWc3hid3EyalhhSVQvaGJrRmV4R214Vno4SDVmbXVDT0FCd0lCTGtUUEV1ZkdBSmdcbjU2dzNVOWd4ODVnWnBTdGZuUTRqM1M0REFkUm5KZkcrMHZvakdocEJ3UUtCZ1FEN0NONG9yZVFsaStaZXV3RWxcbjcwUS85QTBGa3RoNGRKbkhhNDJQOVptcUNyUkplYVBOWlhxQ2Vmai90MjhXTzJjbEw5dWl1YWZORms3M2lyeVRcblQ3OVlwK1VsZ054bG1tMEdYbmpPYWdLOG4zZ2RUZnMySnJwMFUxSU5EQnh2citYR0xpTDRwTHVJcEQ3WlcwM3dcbmp4WkFneHRmRWMxWUxEZnJVNjJsL0dCdUxRS0JnUUR0Y2tkdld4NG53OXV0a3V5bUN2QWZ1YUVteXo0VWw1V0Vcblp5UTBGTzNmY3grTHBCcFREZ3lEVFN1NWV6anpVRjQwU0M0SVRxV0pzMngraTROQnNJN2xPS0Q2SFVOYlRaSE5cbmZpcXVEajgxY0Q3YXhGZXVEb0tjMDkzbDlhNXZOVlZyVnF0bnhVeEhtUnZKRHI4TlVVU3ZpcXBuVUJjbUhJUkRcbjlrRndFckQrTVFLQmdIOFFHZ0xWSWFtdmlrZGd1RkFQTDZoL1N5Z0xEKzdJZGgzdVhwVURaMmdlU3VyMTJ1ZFhcbitnNlkxbVA0NFEyTHU4V2kxN1VoNjhGdkRVRld3K1I4ZFFuVzBiR043QUN4allXdnc4NFc4cE91MUFsaE0wcFJcbmlBYmhOYUxOQW9lMXJNUUhEa1IwZlVmSWV0ZGgwNjF6ZjN2ZjRMYmFOK250VjlDUlprK2gwdDF4QW9HQkFKcjZcblJ1UElqaE1ZUTg2em9kL3lMYTRYUTdhRld6eW5mNEJPclpPTXdZRmhxNHBDRHFoODkrL1BNNlc1Wm45d3lqdkhcbmpMd0JVUXhpWG9MdDNqckcyVTJGTzVSait5MmhvSE9HVUtjUVIzTkNrdFBJNlEyRERQNzlUY3lsSVRnV2tHMGhcbndYaFdqeVlBS2VGOXpYY012dzd3SzY2STJNTVlRNy96Lzl2OVp5WlJBb0dBVjRON3FFUmJjL2J1MDNIRnVkNXFcbldwM2pjNlVtY3VGMWU2YlovMzVNMVloNmtvVDcwTk9NQ1MvUVdQQUtpc25UQkt3dmRDMjRXZGsvbk9tODJoUnNcbjVPMW0xV1prUlVrTGVoZVk4b0pJZ1RaYlBobDNqUmtJRExseXlib0JydU52cU9nZkZSRVk0Z0NZbUR5d3hObzRcbnBSbm5kS0kxQlFSNEphYXg1TEk2NkE4PVxuLS0tLS1FTkQgClBSSVZBVEUgS0VZLS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJoYXh3ZWItZnJAaGF4d2ViLWZyLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExNTEwMDE0MzcwMzE2MDM1NTAzNSIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2hheHdlYi1mciU0MGhheHdlYi1mci5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
  services:
    - docker

dependencies:
  pre:
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update kubectl
    - echo $ACCT_AUTH | base64 --decode -i > ${HOME}/account-auth.json
    - sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account ${SERVICE_ACCOUNT} --key-file ${HOME}/account-auth.json
    - sudo /opt/google-cloud-sdk/bin/gcloud config set project $PROJECT_NAME
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet config set container/cluster $CLUSTER_NAME
    # Reading the zone from the env var is not working so we set it here
    - sudo /opt/google-cloud-sdk/bin/gcloud config set compute/zone ${CLOUDSDK_COMPUTE_ZONE}
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet container clusters get-credentials $CLUSTER_NAME
    - docker build -t gcr.io/${PROJECT_NAME}/${DOCKER_IMAGE}:$CIRCLE_SHA1 .
    # Using a separate tag command until Docker 1.10 is available on CircleCI, then we can use two tags in the build command above
    - docker tag us.gcr.io/${PROJECT_NAME}/${DOCKER_IMAGE}:$CIRCLE_SHA1 gcr.io/${PROJECT_NAME}/${DOCKER_IMAGE}:latest

deployment:
  prod:
    branch: master
    commands:
      - ./deploy.sh
